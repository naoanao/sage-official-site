name: D1 Knowledge Loop (Mock)
on:
  push:
      branches: [ ci/final-test-branch ]
        pull_request:

        jobs:
          test:
              runs-on: ubuntu-latest
                  env:
                        SAGE_MOCK: "1"
                              PYTHONUTF8: "1"
                                    PYTHONIOENCODING: "utf-8"
                                        steps:
                                              - uses: actions/checkout@v4
                                                    - uses: actions/setup-python@v5
                                                            with:
                                                                      python-version: "3.11"
                                                                                cache: "pip"
                                                                                      - name: Install deps
                                                                                              run: |
                                                                                                        python -m pip install --upgrade pip
                                                                                                                  pip install -r requirements.txt
                                                                                                                        - name: Start API server
                                                                                                                                run: |
                                                                                                                                          mkdir -p backend/logs
                                                                                                                                                    nohup python -u backend/flask_server.py > backend/logs/sage_ultimate.log 2>&1 &
                                                                                                                                                              sleep 5
                                                                                                                                                                        echo "---- ci: first log (sage_ultimate.log) ----"
                                                                                                                                                                                  tail -n 200 backend/logs/sage_ultimate.log || true
                                                                                                                                                                                            echo "---- ci: listen ports ----"
                                                                                                                                                                                                      ss -ltnp || true
                                                                                                                                                                                                            - name: Wait for Server (180s)
                                                                                                                                                                                                                    run: |
                                                                                                                                                                                                                              python - <<'PY'
                                                                                                                                                                                                                                        import socket, time, sys
                                                                                                                                                                                                                                                  deadline = time.time() + 180
                                                                                                                                                                                                                                                            while time.time() < deadline:
                                                                                                                                                                                                                                                                          try:
                                                                                                                                                                                                                                                                                            with socket.create_connection(("127.0.0.1", 8080), timeout=1):
                                                                                                                                                                                                                                                                                                                  print("port 8080 open")
                                                                                                                                                                                                                                                                                                                                        sys.exit(0)
                                                                                                                                                                                                                                                                                                                                                      except Exception:
                                                                                                                                                                                                                                                                                                                                                                        time.sleep(2)
                                                                                                                                                                                                                                                                                                                                                                                  sys.exit("timeout waiting for :8080")
                                                                                                                                                                                                                                                                                                                                                                                            PY
                                                                                                                                                                                                                                                                                                                                                                                                  - name: Run pilot E2E test
                                                                                                                                                                                                                                                                                                                                                                                                          run: python test_pilot_pipeline.py
                                                                                                                                                                                                                                                                                                                                                                                                                - name: Upload artifacts
                                                                                                                                                                                                                                                                                                                                                                                                                        if: always()
                                                                                                                                                                                                                                                                                                                                                                                                                                uses: actions/upload-artifact@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                        with:
                                                                                                                                                                                                                                                                                                                                                                                                                                        
